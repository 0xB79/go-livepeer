# This is the one with Docker
image: Windows Server 2019

test_script:
  - docker login -u %DOCKER_USER% -p %DOCKER_PASS%

  # First, build/cache the platform-specific root container
  - ps: Start-Process docker -ArgumentList 'pull livepeerci/build-platform:latest-windows' -Wait -EV Err -EA SilentlyContinue
  - docker build -m 4gb --cache-from=livepeerci/build-platform:latest-windows -t livepeerci/build-platform:latest -f .\docker\Dockerfile.build-windows .
  - docker tag livepeerci/build-platform:latest livepeerci/build-platform:latest-windows
  - docker push livepeerci/build-platform:latest-windows

  # Then, build/cache the container shared between Windows and Linux
  - ps: Start-Process docker -ArgumentList 'pull livepeerci/build:latest-windows' -Wait -EV Err -EA SilentlyContinue
  - docker build -m 4gb --cache-from=livepeerci/build:latest-windows -t livepeerci/build:latest -f .\docker\Dockerfile.build .
  - docker tag livepeerci/build:latest livepeerci/build:latest-windows
  - docker push livepeerci/build:latest-windows

  - docker run --rm -e GCLOUD_KEY=%GCLOUD_KEY% -e GCLOUD_SECRET=%GCLOUD_SECRET%  -e DISCORD_URL=%DISCORD_URL% -e CIRCLE_BRANCH=%APPVEYOR_REPO_BRANCH% livepeerci/build:latest

# Don't actually build.
build: off
